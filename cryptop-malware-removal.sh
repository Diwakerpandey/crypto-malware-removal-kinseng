#!/bin/bash

# Function to check if the user has sudo privileges
check_sudo() {
  if [[ $(id -u) -ne 0 ]]; then
    echo "This script requires sudo privileges. Please run as root or with sudo."
    exit 1
  fi
}

# Function to detect and kill malicious processes
kill_malware_processes() {
  echo "Detecting malicious processes..."
  kinsing_pid=$(ps aux | grep -i kinsing | grep -v grep | awk '{print $2}')
  kdevtmp_pid=$(ps aux | grep kdevtmp | grep -v grep | awk '{print $2}')

  for pid in $kinsing_pid $kdevtmp_pid; do
    if [[ -n "$pid" ]]; then
      echo "Killing process with PID $pid"
      kill -9 $pid
    fi
  done
}

# Function to search and delete malware-related files and folders
delete_malware_files() {
  echo "Searching for and deleting malware-related files and folders..."
  find / -type f -name "*kinsing*" -exec rm -f {} \; 2>/dev/null
  find / -type f -name "*kdevtmp*" -exec rm -f {} \; 2>/dev/null
  find / -type d -name "*kinsing*" -exec rm -rf {} \; 2>/dev/null
  find / -type d -name "*kdevtmp*" -exec rm -rf {} \; 2>/dev/null

  sudo rm -rf /tmp/*kinsing*
  sudo rm -rf /var/tmp/*kinsing*
  sudo rm -f /etc/data/kinsing
  sudo rm -f /tmp/kdevtmpfsi
  sudo rm -f /etc/kinsing
}

# Function to update the server OS
update_server_os() {
  if [[ -f /etc/almalinux-release ]]; then
    echo "Updating AlmaLinux server..."
    sudo dnf update -y
  elif [[ -f /etc/lsb-release ]]; then
    echo "Updating Ubuntu server..."
    sudo apt update && sudo apt upgrade -y
  else
    echo "Unsupported OS. This script only supports AlmaLinux or Ubuntu."
    exit 1
  fi
}

# Function to update CyberPanel
update_cyberpanel() {
  echo "Updating CyberPanel..."
  sudo bash <(curl -s https://raw.githubusercontent.com/usmannasir/cyberpanel/stable/preUpgrade.sh || wget -qO - https://raw.githubusercontent.com/usmannasir/cyberpanel/stable/preUpgrade.sh)
}

# Execute functions
check_sudo
kill_malware_processes
delete_malware_files
update_server_os
update_cyberpanel

echo "Script execution completed successfully."
